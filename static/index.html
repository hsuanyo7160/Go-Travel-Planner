<!doctype html>
<html lang="zh-Hant">
<head>
  <link rel="preload" as="image" href="Source_img/image1.jpg">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—…éŠåŠ©æ‰‹ï½œè¡Œç¨‹å»ºç«‹ç²¾éˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <!-- Google Fonts: Noto Sans TC (UI) + Noto Serif TC (headings) -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ===== äº®è‰²ä¸»é¡Œï¼ˆæ•´ç†å¾Œï¼‰===== */
    :root{
      --bg:#f5f7fb;      /* ç¶²ç«™èƒŒæ™¯ï¼ˆäº®ï¼‰ */
      --card:#ffffff;     /* å¡ç‰‡èƒŒæ™¯ï¼ˆç™½ï¼‰ */
      --muted:#6b7280;    /* æ¬¡è¦æ–‡å­—ï¼ˆç°ï¼‰ */
      --border:#e5e7eb;   /* é‚Šæ¡†æ·ºç° */
      --accent:#2563eb;   /* ä¸»è‰²ï¼ˆè—ï¼‰ */
    }

    main.container {
      scroll-margin-top: 100px; /* è‡ªå·±èª¿æ•´ï¼Œ80px å·¦å³è©¦è©¦ */
    }

    /* åŸºæœ¬è‰²èˆ‡å®¹å™¨ */
    body{background:var(--bg);color:#0f172a}
    .card{background:var(--card);border:1px solid var(--border);box-shadow:0 8px 24px rgba(2,6,23,.06)}
    .text-muted{color:var(--muted)!important}

    /* è¡¨å–®èˆ‡æŒ‰éˆ• */
    .form-control,.form-select{background:#ffffff;color:#111827;border-color:#d1d5db}
    .form-control:focus,.form-select:focus{border-color:#93c5fd;box-shadow:0 0 0 .2rem rgba(147,197,253,.35)}
    .btn-primary{background:var(--accent);border-color:var(--accent)}

    /* æœˆæ›† */
    .calendar-wrap{ max-width: 520px; margin: 0 auto; position: relative; }
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:.3rem}
    .weekday{font-size:.85rem;color:var(--muted);text-align:center}
    .day{
      /* è®“ä¸Šä¸‹æ›´çª„ï¼šå›ºå®šé«˜åº¦ */
      aspect-ratio:auto; height:40px;
      border:1px solid var(--border);border-radius:.4rem;display:flex;align-items:center;justify-content:center;cursor:pointer;background:#ffffff;color:#0f172a
    }
    .day.disabled{opacity:.35;cursor:not-allowed}
    .day.selected{outline:2px solid #93c5fd;background:#eff6ff}

    /* åå¥½é¸é …ï¼ˆchipï¼‰ */
    .pref-chip{background:#f3f4f6;color:#111827;border:1px solid #d1d5db;border-radius:999px;padding:.35rem .8rem;cursor:pointer;transition:all .15s}
    .pref-chip:hover{background:#e5e7eb}
    .pref-chip.active{background:#d1d5db;border-color:#9ca3af;color:#111}

    /* å…¶ä»–è¼”åŠ© */
    .sticky-footer{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(245,247,251,0),var(--bg) 30%);padding-top:1rem}
    .badge-soft{background:#eef2ff;color:#1e3a8a;border:1px solid #dbeafe}
    code.inline{background:#f8fafc;border:1px solid var(--border);padding:.1rem .35rem;border-radius:.3rem}
    .pointer{cursor:pointer}

    /* Reset æŒ‰éˆ•å¸é™„åœ¨æœˆæ›†å³ä¸‹ */
    #btnResetDates{ position:absolute; right:0; bottom:-6px; }

    /* navbar å³å´ä¸æŠ˜è¡Œã€select å¯¬åº¦è‡ªå‹• */
    .navbar .flex-nowrap { flex-wrap: nowrap; }
    .navbar .form-select.w-auto { width: auto; }

    /* åˆªé™¤éˆ•åœç”¨æ¨£å¼ */
    #btnDelete:disabled { opacity:.5; cursor:not-allowed; }
  </style>
</head>
<body>
  <!-- Hero å°é¢ -->
  <header class="hero">
    <div class="hero-slides"></div>
    <div class="hero-overlay"></div>
    <div class="hero-content container text-center">
      <h1 class="hero-title">æ—…éŠåŠ©æ‰‹</h1>
      <p class="hero-sub">å¿«é€Ÿæ“¬å®šä¸€è¶Ÿé©åˆä½ çš„è¡Œç¨‹</p>
      <button id="heroBtn" class="btn btn-primary btn-lg">é–‹å§‹å»ºç«‹è¡Œç¨‹</button>
    </div>
  </header>
  <nav class="navbar navbar-expand-lg mb-4" style="background:linear-gradient(90deg,#ffffff,#f5f7fb);border-bottom:1px solid var(--border)">
    <div class="container">
      <span class="navbar-brand text-truncate" style="max-width:40vw">æ—…éŠåŠ©æ‰‹ï½œè¡Œç¨‹å»ºç«‹ç²¾éˆ</span>
      
      <div class="ms-auto d-flex align-items-center gap-2 flex-nowrap">
        <span class="text-muted small text-nowrap flex-shrink-0">è¡Œç¨‹ï¼š</span>
        
        <select id="tripSel" class="form-select form-select-sm w-auto flex-shrink-0" style="min-width:200px">
          <option value="new" selected>ï¼ˆæ–°å»ºï¼‰</option>
        </select>

          <button id="btnViewPlan"
                  class="btn btn-outline-secondary btn-sm"
                  disabled>
            ğŸ“… æŸ¥çœ‹æ­·å²è¡Œç¨‹
          </button>
      </div>
    </div>
  </nav>

  <main class="container pb-5">
    <!-- ç§‹å¤©ä¸»é¡ŒåŒ…è£¹ï¼šæœƒåœ¨èƒŒæ™¯é¡¯ç¤ºæº«æš–çš„è‰²èª¿èˆ‡åœ–ç‰‡ -->
    <div class="autumn-section rounded-4 p-4 mb-4">
    <!-- Step 1: åŸºæœ¬è³‡è¨Š -->
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="mb-3">Step 1ï½œè¡Œç¨‹åŸºæœ¬è³‡è¨Š</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">è¡Œç¨‹åç¨±</label>
            <input id="tripName" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ 5 æ—¥è¼•æ—…è¡Œ">
          </div>
          <div class="col-md-6">
            <label class="form-label">åœ°å€ / åŸå¸‚</label>
            <input id="region" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ã€é—œè¥¿ã€æ²–ç¹©ã€é¦–çˆ¾ã€å°åŒ—">
          </div>
          <div class="col-md-3">
            <label class="form-label">é ç®—ï¼ˆTWDï¼‰</label>
            <div class="input-group">
              <input id="budget" type="number" min="0" step="1000" class="form-control" placeholder="ä¾‹å¦‚ï¼š30000">
            </div>
            <div class="form-text text-muted">ä»¥åƒå…ƒç‚ºå–®ä½èª¿æ•´ã€‚</div>
          </div>
          <div class="col-md-3">
            <label class="form-label">äººæ•¸</label>
            <input id="people" type="number" min="1" class="form-control" value="1">
          </div>
          <div class="col-md-3">
            <label class="form-label">å–®æ—¥éŠç©æ™‚é•·ï¼ˆå°æ™‚ï¼‰</label>
            <input id="dailyHours" type="number" min="1" max="24" class="form-control" value="8">
          </div>
          
        </div>
      </div>
    </div>

    <!-- Step 2: æœˆæ›†é¸æ—¥ -->
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="mb-3">Step 2ï½œé¸æ“‡æ—¥æœŸå€é–“</h5>
        <div class="row g-3">
          <div class="col-12">
            <div class="calendar-wrap">
              <div class="row g-3 align-items-start">
                <div class="col-md-4">
                  <div class="mb-2">
                    <label class="form-label mb-0">åŸºæº–æœˆä»½ï¼š</label>
                    <div class="d-flex gap-2 mt-1">
                      <select id="yearSel" class="form-select w-auto"></select>
                      <select id="monthSel" class="form-select w-auto"></select>
                    </div>
                  </div>
                  <div class="mb-3"><small class="text-muted">ç”¨ä¸‹æ–¹æœˆæ›†é¸æ“‡å‡ºç™¼èˆ‡çµæŸæ—¥æœŸ</small></div>
                  <div class="d-flex flex-column gap-2">
                    <div><span class="badge badge-soft">å‡ºç™¼ï¼š<span id="startText">â€”</span></span></div>
                    <div><span class="badge badge-soft">çµæŸï¼š<span id="endText">â€”</span></span></div>
                    <div><span class="badge badge-soft">å¤©æ•¸ï¼š<span id="daysText">0</span></span></div>
                  </div>
                </div>
                <div class="col-md-8">
                  <div class="d-grid" style="grid-template-columns:repeat(7,1fr);gap:.3rem">
                    <div class="weekday">æ—¥</div>
                    <div class="weekday">ä¸€</div>
                    <div class="weekday">äºŒ</div>
                    <div class="weekday">ä¸‰</div>
                    <div class="weekday">å››</div>
                    <div class="weekday">äº”</div>
                    <div class="weekday">å…­</div>
                  </div>
                  <div id="calendar" class="calendar mt-2"></div>
                  <div class="mt-2"><button id="btnResetDates" class="btn btn-sm btn-outline-secondary">Reset</button></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: æ—…éŠç¿’æ…£åå¥½ -->
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="mb-3">Step 3ï½œæœ‰åå¥½çš„æ—…éŠç¿’æ…£å—ï¼Ÿ</h5>
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">è¡Œç¨‹ç¯€å¥</label>
            <div id="pace" class="d-flex flex-wrap gap-2"></div>
          </div>
          <div class="col-12">
            <label class="form-label">åå¥½é¡å‹</label>
            <div id="types" class="d-flex flex-wrap gap-2"></div>
          </div>
          <div class="col-12">
            <label class="form-label">äº¤é€šåå¥½</label>
            <div id="transport" class="d-flex flex-wrap gap-2"></div>
          </div>
          <div class="col-12">
            <label class="form-label">ç”¨é¤å–å‘</label>
            <div id="dining" class="d-flex flex-wrap gap-2"></div>
          </div>
          <div class="card-body d-flex justify-content-center gap-2 align-items-center">
            <button id="btnSubmit" class="btn btn-primary">å»ºç«‹è¡Œç¨‹</button>
            <button id="btnDelete" class="btn btn-outline-danger">åˆªé™¤è¡Œç¨‹</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Debug é è¦½å€ï¼ˆå¯æ”¶åˆï¼‰ -->
    <div class="card mt-3">
      <div class="card-body">
        <details>
          <summary class="pointer">JSON é è¦½</summary>
          <pre id="jsonPreview" class="mt-3" style="white-space:pre-wrap"></pre>
        </details>
      </div>
    </div>

    </div> <!-- /.autumn-section -->
  </main>

  <script>
    // ====== 0. Hero å€å¡Šé‚è¼¯ ======
    document.addEventListener('DOMContentLoaded', function(){
      const btn = document.getElementById('heroBtn');
      if(btn){
        btn.addEventListener('click', function(){
          const main = document.querySelector('main.container');
          if (main) {main.scrollIntoView({ behavior: 'smooth' });}
        });
      }
      
      // Hero åœ–ç‰‡è¼ªæ’­
      (function heroSlideshow(){
        const images = [
          'Source_img/image1.jpg',
          'Source_img/image2.jpg'
        ];
        const intervalMs = 10000;
        const container = document.querySelector('.hero-slides');
        if(!container || !images || images.length===0) return;

        const slides = images.map((src,i)=>{
          const d = document.createElement('div');
          d.className = 'hero-slide'+(i===0? ' active':'');
          d.style.backgroundImage = `url(${src})`;
          container.appendChild(d);
          return d;
        });

        let idx = 0;
        setInterval(()=>{
          const next = (idx+1) % slides.length;
          slides[idx].classList.remove('active');
          slides[next].classList.add('active');
          idx = next;
        }, intervalMs);
      })();
    });
    // ====== 1. è¨­å®š ======
    const storeKey = 'travel_assistant_trip_setup_v1';
    const API = "/api";

    // è®€å–ç¶²å€åƒæ•¸ï¼ˆå¾ chat.html å›ä¾†æ™‚æœƒå¸¶ trip / fromï¼‰
    const urlParams = new URLSearchParams(location.search);
    const initialTripId = urlParams.get('trip') || urlParams.get('tripId');
    const fromChat = urlParams.get('from') === 'chat';
    // ç‹€æ…‹åˆå§‹åŒ–
    // åšä¸€å€‹ã€Œå®Œå…¨ç©ºç™½ã€çš„åˆå§‹ç‹€æ…‹
    function makeEmptyState() {
      const now = new Date();
      return {
        name: '',
        region: '',
        budget: 0,
        people: 1,
        dailyHours: 8,
        year: now.getFullYear(),
        month: now.getMonth() + 1,
        startDay: null,
        endDay: null,
        prefs: { pace: 'é©ä¸­', types: [], transport: [], dining: [] }
      };
    }

    let state = makeEmptyState();
    let currentTripPlan = [];
    let loadedState = null; // â–¼â–¼â–¼ æ–°å¢é€™å€‹è®Šæ•¸ï¼šç”¨ä¾†å­˜ã€Œå‰›è¼‰å…¥æ™‚çš„åŸå§‹è³‡æ–™ã€

    function tryLoadState(){ try{ return JSON.parse(localStorage.getItem(storeKey)||''); }catch{ return null; } }
    function saveState(){ localStorage.setItem(storeKey, JSON.stringify(state)); renderPreview(); }

    // ====== 2. DOM å…ƒç´  ======
    const els = {
      tripName: document.getElementById('tripName'), region: document.getElementById('region'),
      budget: document.getElementById('budget'), people: document.getElementById('people'), dailyHours: document.getElementById('dailyHours'),
      yearSel: document.getElementById('yearSel'), monthSel: document.getElementById('monthSel'), calendar: document.getElementById('calendar'),
      startText: document.getElementById('startText'), endText: document.getElementById('endText'), daysText: document.getElementById('daysText'),
      btnSubmit: document.getElementById('btnSubmit'), btnDelete: document.getElementById('btnDelete'),
      jsonPreview: document.getElementById('jsonPreview'),
      pace: document.getElementById('pace'), types: document.getElementById('types'), transport: document.getElementById('transport'), dining: document.getElementById('dining'),
      resetDates: document.getElementById('btnResetDates'), tripSel: document.getElementById('tripSel'),
      pName: document.getElementById('pName'), pRegion: document.getElementById('pRegion'), pDate: document.getElementById('pDate'),
      pDays: document.getElementById('pDays'), pPeople: document.getElementById('pPeople'), pHours: document.getElementById('pHours')
    };

    // ====== 3. è¼”åŠ©å‡½å¼ ======

    // æª¢æŸ¥é—œéµæ¬„ä½æ˜¯å¦æ”¹è®Š (åœ°é»ã€æ—¥æœŸã€å¤©æ•¸ã€åå¥½)
    function hasCriticalChanges(current) {
        if (!loadedState) return true; // å¦‚æœæ˜¯æ–°å»ºçš„ï¼Œç•¶ç„¶ç®—æœ‰è®Š
        
        // æ¯”å°åŸºæœ¬æ¬„ä½
        if (current.region !== loadedState.region) return true;
        if (current.start_date !== loadedState.start_date) return true;
        if (current.days !== loadedState.days) return true;

        // æ¯”å°åå¥½ (å› ç‚ºæ˜¯ç‰©ä»¶/é™£åˆ—ï¼Œè½‰æˆ JSON å­—ä¸²æ¯”å°æœ€å¿«)
        const currentPrefs = JSON.stringify(current.preferences);
        const oldPrefs = JSON.stringify(loadedState.prefs);
        if (currentPrefs !== oldPrefs) return true;

        return false; // éƒ½æ²’è®Š
    }
    
    // â–¼â–¼â–¼ æ–°å¢é€™å€‹å‡½å¼ï¼šç”¨ä¾†å¾¹åº•æ¸…ç©ºè¡¨å–®èˆ‡ç‹€æ…‹ â–¼â–¼â–¼
    function resetForm() {
      // 1. æ¸…é™¤ LocalStorage
      localStorage.removeItem(storeKey);
      
      // 2. ç‹€æ…‹å›æ­¸ç©ºç™½
      state = makeEmptyState();
      
      // 3. ç•«é¢åŒæ­¥
      syncInputs();
      buildCalendar();
      
      // 4. é‡ç½®æ‰€æœ‰é¸é … (Chip)
      renderChips(els.pace, paceOpts, true, 'pace');
      renderChips(els.types, typeOpts, false, 'types');
      renderChips(els.transport, transportOpts, false, 'transport');
      renderChips(els.dining, diningOpts, false, 'dining');
      
      // 5. æŒ‰éˆ•ç‹€æ…‹æ›´æ–°
      updateButtonUI();
      
      // 6. é è¦½æ›´æ–°
      renderPreview();
    }


    // ğŸŸ¢ [é—œéµä¿®æ”¹] å¼·åˆ¶æ›´æ–°æŒ‰éˆ•ç‹€æ…‹çš„å‡½å¼
    function updateButtonUI() {
        const isNew = (!els.tripSel.value || els.tripSel.value === 'new');
        if (isNew) {
            els.btnSubmit.textContent = 'å»ºç«‹è¡Œç¨‹';
            els.btnSubmit.className = 'btn btn-primary'; // è—è‰²
            if(els.btnDelete) els.btnDelete.disabled = true;
        } else {
            els.btnSubmit.textContent = 'æ›´æ–°è¡Œç¨‹';
            els.btnSubmit.className = 'btn btn-success'; // ç¶ è‰²
            if(els.btnDelete) els.btnDelete.disabled = false;
        }

        const btnViewPlan = document.getElementById("btnViewPlan");
        if (btnViewPlan) {
          btnViewPlan.disabled = isNew;
        }
    }

    function renderPlan(plan) {
      if (!plan || plan.length === 0) {
        return "<p class='text-muted'>å°šæœªç”¢ç”Ÿè©³ç´°è¡Œç¨‹</p>";
      }

      return plan.map(day => `
        <section class="mb-4">
          <h5 class="fw-bold">
            ç¬¬ ${day.day_index} å¤©
            <span class="text-muted small">(${day.date})</span>
          </h5>

          <ul class="list-group">
            ${day.items.map(item => `
              <li class="list-group-item">
                <div>
                  <strong>${item.time || ""}</strong>
                  ${item.title || ""}
                </div>
                ${item.note
                  ? `<div class="text-muted small mt-1">${item.note}</div>`
                  : ""}
              </li>
            `).join("")}
          </ul>
        </section>
      `).join("");
    }

    function initYearMonth(){
      const y = state.year; const m = state.month; const nowY = new Date().getFullYear();
      els.yearSel.innerHTML = [-1,0,1,2,3].map(i=>`<option ${nowY+i===y?'selected':''}>${nowY+i}</option>`).join('');
      els.monthSel.innerHTML = Array.from({length:12},(_,i)=>i+1).map(v=>`<option ${v===m?'selected':''}>${v}</option>`).join('');
    }

    function renderChips(container, options, single=false, key){
      container.innerHTML='';
      options.forEach(opt=>{
        const active = single ? (state.prefs[key]===opt) : (state.prefs[key]?.includes(opt));
        const btn = document.createElement('button');
        btn.type='button'; btn.className='pref-chip'+(active?' active':''); btn.textContent=opt;
        btn.addEventListener('click', ()=>{
          if(single){ state.prefs[key] = opt; }
          else{ const arr = new Set(state.prefs[key]||[]); if(arr.has(opt)) arr.delete(opt); else arr.add(opt); state.prefs[key] = Array.from(arr); }
          saveState(); renderChips(container, options, single, key);
        });
        container.appendChild(btn);
      });
    }

    function buildCalendar(){
      const y = parseInt(els.yearSel.value);
      const m = parseInt(els.monthSel.value);
      state.year = y;
      state.month = m;
      saveState();

      const dim = new Date(y, m, 0).getDate();
      const off = new Date(y, m - 1, 1).getDay();

      const today = new Date();
      today.setHours(0,0,0,0);

      let html = '';
      for (let i = 0; i < off; i++) html += `<div></div>`;

      for (let d = 1; d <= dim; d++) {

        // é€™ä¸€å¤©çš„çœŸå¯¦æ—¥æœŸ
        const thisDate = new Date(y, m - 1, d);
        thisDate.setHours(0,0,0,0);

        // æ˜¯å¦ç‚ºéæœŸæ—¥æœŸ
        const isPast = thisDate < today;

        // æ˜¯å¦è¢«é¸ä¸­
        let sel = false;
        if (state.startDay && !state.endDay) {
          sel = (d === state.startDay);
        } else if (state.startDay && state.endDay) {
          sel = (d >= state.startDay && d <= state.endDay);
        }

        html += `
          <div class="day 
            ${sel ? 'selected' : ''} 
            ${isPast ? 'disabled' : ''}
          " 
          data-day="${isPast ? '' : d}"
          >
            ${d}
          </div>`;
      }

      els.calendar.innerHTML = html;
      updateRangeText();

      // éæœŸæ—¥æœŸä¸èƒ½é»
      els.calendar.querySelectorAll('.day:not(.disabled)').forEach(el => {
        el.addEventListener('click', () => {
          selectDay(parseInt(el.dataset.day));
        });
      });
    }

    function selectDay(d){
      if(!state.startDay||(state.startDay&&state.endDay)){ state.startDay=d; state.endDay=null; }
      else{ if(d<state.startDay){state.endDay=state.startDay;state.startDay=d;}else{state.endDay=d;} }
      saveState(); buildCalendar();
    }

    function updateRangeText(){
      const y = state.year;
      const m = state.month;
      const s = state.startDay;
      const e = state.endDay;
      const pad = n => String(n).padStart(2, '0');

      els.startText.textContent = s ? `${y}-${pad(m)}-${pad(s)}` : 'â€”';

      // âœ… å¦‚æœåªæœ‰é¸ startï¼Œå°±å…ˆæŠŠ end é¡¯ç¤ºåŒä¸€å¤©ï¼ˆæˆ–ä½ è¦ä¿æŒ "â€”" ä¹Ÿå¯ä»¥ï¼‰
      if (e) {
        els.endText.textContent = `${y}-${pad(m)}-${pad(e)}`;
      } else if (s) {
        els.endText.textContent = `${y}-${pad(m)}-${pad(s)}`; // åªé¸èµ·é»æ™‚å…ˆç•¶ä½œ 1 å¤©
      } else {
        els.endText.textContent = 'â€”';
      }

      let days = 0;
      if (s && e) {
        days = e - s + 1;
      } else if (s && !e) {
        days = 1; // âœ… åªé¸èµ·å§‹æ—¥å…ˆç®— 1 å¤©
      }
      els.daysText.textContent = days;
    }


    function currentPayload(){
      const s=state.startDay, e=state.endDay, pad=n=>String(n).padStart(2,'0');
      return {
        name: state.name?.trim()||'', region: state.region?.trim()||'',
        budget_twd: Number(state.budget)||0, people: Number(state.people)||1, daily_hours: Number(state.dailyHours)||8,
        start_date: s?`${state.year}-${pad(state.month)}-${pad(s)}`:'', days: (s&&e)?(e-s+1):0,
        preferences: state.prefs
      };
    }

    function syncInputs(){
      els.tripName.value=state.name; els.region.value=state.region; els.budget.value=state.budget;
      els.people.value=state.people; els.dailyHours.value=state.dailyHours; els.yearSel.value=state.year; els.monthSel.value=state.month;
      renderPreview();
    }

    function renderPreview(){
      if(els.jsonPreview) els.jsonPreview.textContent = JSON.stringify(currentPayload(), null, 2);
      const p = currentPayload();
      if(els.pName) els.pName.textContent = p.name || 'â€”';
      if(els.pRegion) els.pRegion.textContent = p.region || 'â€”';
      if(els.pDate) els.pDate.textContent = p.start_date || 'â€”';
      if(els.pDays) els.pDays.textContent = p.days;
      if(els.pPeople) els.pPeople.textContent = p.people;
      if(els.pHours) els.pHours.textContent = p.daily_hours;
    }

    // ====== 4. äº‹ä»¶ç¶å®š ======
    const paceOpts=['æ‚ é–’','é©ä¸­','ç·Šæ¹Š'], typeOpts=['æ™¯é»','ç¾é£Ÿ','è³¼ç‰©','è‡ªç„¶','åšç‰©é¤¨','å¤œç”Ÿæ´»','è¦ªå­','å±•æ¼”'];
    const transportOpts=['æ­¥è¡Œ','å¤§çœ¾é‹è¼¸','è¨ˆç¨‹è»Š','è‡ªé§•'], diningOpts=['åœ¨åœ°å°åƒ','ç±³å…¶æ—/è©•é‘‘','å¹³åƒ¹å„ªå…ˆ','ç´ é£Ÿå‹å–„'];

    initYearMonth();
    renderChips(els.pace,paceOpts,true,'pace'); renderChips(els.types,typeOpts,false,'types');
    renderChips(els.transport,transportOpts,false,'transport'); renderChips(els.dining,diningOpts,false,'dining');

    els.budget.addEventListener('input',()=>{state.budget=els.budget.value;saveState();});
    els.tripName.addEventListener('input',()=>{state.name=els.tripName.value;saveState();});
    els.region.addEventListener('input',()=>{state.region=els.region.value;saveState();});
    els.people.addEventListener('input',()=>{state.people=els.people.value;saveState();});
    els.dailyHours.addEventListener('input',()=>{state.dailyHours=els.dailyHours.value;saveState();});
    els.yearSel.addEventListener('change',buildCalendar); els.monthSel.addEventListener('change',buildCalendar);
    if(els.resetDates) els.resetDates.addEventListener('click', ()=>{state.startDay=null;state.endDay=null;saveState();buildCalendar();});

    // ====== 5. API è¼‰å…¥ ======
    async function fetchJSON(url){const r=await fetch(url);if(!r.ok)throw new Error(r.status);return r.json();}
    
    async function loadTripList(){
      try{
        const list = await fetchJSON(`${API}/trips`);

        els.tripSel.innerHTML = 
          `<option value="new">ï¼ˆæ–°å»ºï¼‰</option>` +
          list.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

        // é‚è¼¯ä¿®æ”¹ï¼šå¦‚æœæœ‰ ID ä¸”å­˜åœ¨æ–¼åˆ—è¡¨ï¼Œå°±è¼‰å…¥ï¼›å¦å‰‡ä¸€å¾‹æ¸…ç©º
        if (initialTripId && list.some(t => String(t.id) === initialTripId)) {
          els.tripSel.value = initialTripId;
          await loadTripById(initialTripId);   // è¼‰å…¥èˆŠè³‡æ–™
        } else {
          els.tripSel.value = 'new';
          resetForm(); // â–¼â–¼â–¼ é—œéµï¼šæ²’æœ‰ ID æˆ–æ‰¾ä¸åˆ°æ™‚ï¼Œå¼·åˆ¶æ¸…ç©º â–¼â–¼â–¼
        }

        updateButtonUI();
      } catch(e) {
        console.error(e);
      }
    }


    async function loadTripById(id){
      try{
        const t=await fetchJSON(`${API}/trips/${id}`);
        state.name=t.name; state.region=t.region; state.budget=t.budget_twd; state.people=t.people; state.dailyHours=t.daily_hours;
        currentTripPlan = t.plan || [];
        if(t.start_date){const [y,m,d]=t.start_date.split('-').map(Number); state.year=y; state.month=m; state.startDay=d; state.endDay=d+(t.days)-1;}
        state.prefs = t.preferences || { pace: 'é©ä¸­', types: [], transport: [], dining: [] };
        // â–¼â–¼â–¼ æ–°å¢é€™æ®µï¼šæŠŠé—œéµè³‡æ–™å­˜èµ·ä¾†åšå‚™ä»½ (Deep Copy) â–¼â–¼â–¼
        loadedState = JSON.parse(JSON.stringify({
            region: state.region,
            start_date: t.start_date,
            days: t.days,
            prefs: state.prefs
        }));
        // â–²â–²â–² æ–°å¢çµæŸ â–²â–²â–²
        // æ›´æ–° UI
        renderChips(els.pace,paceOpts,true,'pace'); renderChips(els.types,typeOpts,false,'types');
        renderChips(els.transport,transportOpts,false,'transport'); renderChips(els.dining,diningOpts,false,'dining');
        saveState(); syncInputs(); buildCalendar();
        
        // ğŸŸ¢ [é—œéµ] åªè¦è®€å–æˆåŠŸï¼Œå°±å¼·åˆ¶æ›´æ–°æŒ‰éˆ•
        updateButtonUI(); 

      }catch(e){
        alert('è®€å–å¤±æ•—');
        els.tripSel.value = 'new';
        updateButtonUI();
      } 
    }

    els.tripSel.addEventListener('change',()=>{
        if(els.tripSel.value === 'new'){
            // æ‰‹å‹•é¸æ–°å»º -> æ¸…ç©º
            resetForm(); 
        } else {
            // é¸å…¶ä»– -> è¼‰å…¥
            loadTripById(els.tripSel.value);
        }
    });

    // ====== 6. ğŸš€ [æŒ‰éˆ•é‚è¼¯] ======
    els.btnSubmit.addEventListener('click', async ()=>{
      const p = currentPayload();
      if(!p.name || !p.region || !p.start_date || p.days<=0){ alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Šèˆ‡æ—¥æœŸ'); return; }

      const isUpdate = (els.tripSel.value !== 'new');
      
      els.btnSubmit.disabled = true;
      els.btnSubmit.textContent = isUpdate ? 'æ›´æ–°ä¸­â€¦' : 'å»ºç«‹ä¸­â€¦';

      try {
        let finalId = null; 
        
        // â–¼â–¼â–¼ åˆ¤æ–·é—œéµè®Šæ›´ â–¼â–¼â–¼
        // å¦‚æœæ˜¯æ–°å»ºæ¨¡å¼ï¼Œæˆ–æ˜¯é—œéµæ¬„ä½æœ‰è®Šï¼Œå°±éœ€è¦ã€Œé‡ç½®è¡Œç¨‹ã€
        const needReset = !isUpdate || hasCriticalChanges(p);

        if(isUpdate){
          // === æ›´æ–°æ¨¡å¼ ===
          finalId = els.tripSel.value;
          
          // æº–å‚™è¦é€å‡ºçš„è³‡æ–™
          const updateBody = {
                id: Number(finalId),
                name: p.name, region: p.region, start_date: p.start_date, days: p.days,
                budget_twd: p.budget_twd, people: p.people, daily_hours: p.daily_hours,
                preferences: p.preferences,
                // plan æ¬„ä½ä¸æ”¾é€²é€™è£¡ï¼Œä¸‹é¢å‹•æ…‹æ±ºå®š
            };

          // âš ï¸ é—œéµé‚è¼¯ï¼š
          // å¦‚æœéœ€è¦é‡ç½® (åœ°é»æ”¹äº†ã€æ—¥æœŸæ”¹äº†...) -> å‚³é€ plan: [] è®“å¾Œç«¯æ¸…ç©º
          // å¦‚æœä¸éœ€è¦é‡ç½® (åªæ”¹åå­—ã€é ç®—...) -> ä¸å‚³ plan æ¬„ä½ï¼Œå¾Œç«¯(MongoDB)å°±ä¸æœƒå‹•å®ƒ
          if (needReset) {
              updateBody.plan = [];
          }

          const resp = await fetch(`${API}/trips/${finalId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(updateBody)
          });
          if(!resp.ok) throw new Error(await resp.text());

        } else {
          // === æ–°å»ºæ¨¡å¼ (ä¸€å®šå…¨æ˜¯æ–°çš„) ===
          const resp = await fetch(`${API}/trips`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: p.name, region: p.region, start_date: p.start_date, days: p.days,
                budget_twd: p.budget_twd, people: p.people, daily_hours: p.daily_hours,
                preferences: p.preferences
            })
          });
          if(!resp.ok) throw new Error(await resp.text());
          const newTrip = await resp.json();
          finalId = newTrip.id; 
        }

        // â–¼â–¼â–¼ åªæœ‰åœ¨ã€Œéœ€è¦é‡ç½®ã€æ™‚ï¼Œæ‰æ¸…é™¤å°è©±ç´€éŒ„ â–¼â–¼â–¼
        if (needReset) {
            localStorage.removeItem(`chat_history_${finalId}`);
            console.log("é—œéµè³‡æ–™è®Šæ›´ï¼Œå·²é‡ç½®å°è©±èˆ‡è¡Œç¨‹");
        } else {
            console.log("åƒ…æ›´æ–°åŸºæœ¬è³‡æ–™ï¼Œä¿ç•™å°è©±èˆ‡è¡Œç¨‹");
        }

        // è·³è½‰
        window.location.href = `/web/chat.html?trip=${finalId}`;

      } catch(err) {
        console.error(err);
        alert('æ“ä½œå¤±æ•—ï¼š' + err.message);
        els.btnSubmit.disabled=false; 
        updateButtonUI(); 
      }
    });
    
    if (els.btnDelete) {
      els.btnDelete.addEventListener('click', async () => {
        if (!confirm('ç¢ºå®šåˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ')) return;

        try {
          await fetch(`${API}/trips/${els.tripSel.value}`, {
            method: 'DELETE'
          });

          // æ¸…é™¤ç¶²å€åƒæ•¸
          const url = new URL(window.location);
          url.searchParams.delete('trip');
          url.searchParams.delete('tripId');
          window.history.pushState({}, '', url);

          // é‡æ–°è¼‰å…¥æ¸…å–® + æ¸…ç©ºè¡¨å–®
          await loadTripList();
          els.tripSel.value = 'new';
          resetForm();

          //  é¡¯ç¤ºåˆªé™¤æˆåŠŸ Toast
          const toastEl = document.getElementById('deleteToast');
          if (toastEl) {
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
          }

        } catch (e) {
          console.error(e);
          alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      });
    }

    // 1. åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
    initYearMonth(); 
    
    // 2. æ¸²æŸ“ UI å…ƒä»¶
    renderChips(els.pace,paceOpts,true,'pace'); 
    renderChips(els.types,typeOpts,false,'types');
    renderChips(els.transport,transportOpts,false,'transport'); 
    renderChips(els.dining,diningOpts,false,'dining');

    // 3. å»ºç«‹æ—¥æ›† (é€™è¡Œæœ€é‡è¦ï¼Œæ²’è·‘é€™è¡Œæ—¥æ›†å°±æ˜¯ç©ºçš„)
    buildCalendar(); 

    // 4. è¼‰å…¥åˆ—è¡¨èˆ‡ç‹€æ…‹ï¼Œè¼‰å®Œå†ä¾æƒ…æ³æ²å‹•
  (async () => {
    await loadTripList();   // é€™è£¡æœƒæ ¹æ“š initialTripId æ±ºå®š new or loadTripById
    updateButtonUI();

    // å¦‚æœæ˜¯å¾ chat å›ä¾†ï¼Œå°±è‡ªå‹•æ²åˆ° mainï¼ˆæˆ– Step1 cardï¼‰
    if (fromChat) {
      const main = document.querySelector('main.container');
      if (main) {
        main.scrollIntoView({ behavior: 'smooth' });
      }
    }
  })();

    const btnViewPlan = document.getElementById("btnViewPlan");

    if (btnViewPlan) {
      btnViewPlan.addEventListener("click", () => {
        const body = document.getElementById("planModalBody");

        body.innerHTML = `
          <h4 class="mb-3">${state.name || "æœªå‘½åè¡Œç¨‹"}</h4>
          ${renderPlan(currentTripPlan)}
        `;

        const modal = new bootstrap.Modal(
          document.getElementById("planModal")
        );
        modal.show();
      });
    }

  </script>

  <div class="modal fade" id="planModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ğŸ“… è¡Œç¨‹å…§å®¹</h5>
          <button type="button" class="btn-close"
                  data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="planModalBody">
          <!-- è¡Œç¨‹å…§å®¹ -->
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- åˆªé™¤æˆåŠŸ Toast -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="deleteToast"
        class="toast align-items-center text-bg-success border-0"
        role="alert"
        aria-live="assertive"
        aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
           è¡Œç¨‹å·²æˆåŠŸåˆªé™¤
        </div>
        <button type="button"
                class="btn-close btn-close-white me-2 m-auto"
                data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

</body>
</html>
