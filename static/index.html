<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—…éŠåŠ©æ‰‹ï½œè¡Œç¨‹å»ºç«‹ç²¾éˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <!-- Google Fonts: Noto Sans TC (UI) + Noto Serif TC (headings) -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ===== äº®è‰²ä¸»é¡Œï¼ˆæ•´ç†å¾Œï¼‰===== */
    :root{
      --bg:#f5f7fb;      /* ç¶²ç«™èƒŒæ™¯ï¼ˆäº®ï¼‰ */
      --card:#ffffff;     /* å¡ç‰‡èƒŒæ™¯ï¼ˆç™½ï¼‰ */
      --muted:#6b7280;    /* æ¬¡è¦æ–‡å­—ï¼ˆç°ï¼‰ */
      --border:#e5e7eb;   /* é‚Šæ¡†æ·ºç° */
      --accent:#2563eb;   /* ä¸»è‰²ï¼ˆè—ï¼‰ */
    }

    /* åŸºæœ¬è‰²èˆ‡å®¹å™¨ */
    body{background:var(--bg);color:#0f172a}
    .card{background:var(--card);border:1px solid var(--border);box-shadow:0 8px 24px rgba(2,6,23,.06)}
    .text-muted{color:var(--muted)!important}

    /* è¡¨å–®èˆ‡æŒ‰éˆ• */
    .form-control,.form-select{background:#ffffff;color:#111827;border-color:#d1d5db}
    .form-control:focus,.form-select:focus{border-color:#93c5fd;box-shadow:0 0 0 .2rem rgba(147,197,253,.35)}
    .btn-primary{background:var(--accent);border-color:var(--accent)}

    /* æœˆæ›† */
    .calendar-wrap{ max-width: 520px; margin: 0 auto; position: relative; }
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:.3rem}
    .weekday{font-size:.85rem;color:var(--muted);text-align:center}
    .day{
      /* è®“ä¸Šä¸‹æ›´çª„ï¼šå›ºå®šé«˜åº¦ */
      aspect-ratio:auto; height:40px;
      border:1px solid var(--border);border-radius:.4rem;display:flex;align-items:center;justify-content:center;cursor:pointer;background:#ffffff;color:#0f172a
    }
    .day.disabled{opacity:.35;cursor:not-allowed}
    .day.selected{outline:2px solid #93c5fd;background:#eff6ff}

    /* åå¥½é¸é …ï¼ˆchipï¼‰ */
    .pref-chip{background:#f3f4f6;color:#111827;border:1px solid #d1d5db;border-radius:999px;padding:.35rem .8rem;cursor:pointer;transition:all .15s}
    .pref-chip:hover{background:#e5e7eb}
    .pref-chip.active{background:#d1d5db;border-color:#9ca3af;color:#111}

    /* å…¶ä»–è¼”åŠ© */
    .sticky-footer{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(245,247,251,0),var(--bg) 30%);padding-top:1rem}
    .badge-soft{background:#eef2ff;color:#1e3a8a;border:1px solid #dbeafe}
    code.inline{background:#f8fafc;border:1px solid var(--border);padding:.1rem .35rem;border-radius:.3rem}
    .pointer{cursor:pointer}

    /* Reset æŒ‰éˆ•å¸é™„åœ¨æœˆæ›†å³ä¸‹ */
    #btnResetDates{ position:absolute; right:0; bottom:-6px; }

    /* navbar å³å´ä¸æŠ˜è¡Œã€select å¯¬åº¦è‡ªå‹• */
    .navbar .flex-nowrap { flex-wrap: nowrap; }
    .navbar .form-select.w-auto { width: auto; }

    /* åˆªé™¤éˆ•åœç”¨æ¨£å¼ */
    #btnDelete:disabled { opacity:.5; cursor:not-allowed; }
  </style>
</head>
<body>
  <!-- Hero å°é¢ -->
  <header class="hero">
    <div class="hero-slides"></div>
    <div class="hero-overlay"></div>
    <div class="hero-content container text-center">
      <h1 class="hero-title">æ—…éŠåŠ©æ‰‹</h1>
      <p class="hero-sub">å¿«é€Ÿæ“¬å®šä¸€è¶Ÿé©åˆä½ çš„è¡Œç¨‹</p>
      <button id="heroBtn" class="btn btn-primary btn-lg">é–‹å§‹å»ºç«‹è¡Œç¨‹</button>
    </div>
  </header>
  <nav class="navbar navbar-expand-lg mb-4" style="background:linear-gradient(90deg,#ffffff,#f5f7fb);border-bottom:1px solid var(--border)">
    <div class="container">
      <span class="navbar-brand text-truncate" style="max-width:40vw">æ—…éŠåŠ©æ‰‹ï½œè¡Œç¨‹å»ºç«‹ç²¾éˆ</span>
      <div class="ms-auto d-flex align-items-center gap-2 flex-nowrap">
        <span class="text-muted small text-nowrap flex-shrink-0">è¡Œç¨‹ï¼š</span>
        <select id="tripSel" class="form-select form-select-sm w-auto flex-shrink-0" style="min-width:200px">
          <option value="new" selected>ï¼ˆæ–°å»ºï¼‰</option>
        </select>
      </div>
    </div>
  </nav>

  <main class="container pb-5">
    <!-- ç§‹å¤©ä¸»é¡ŒåŒ…è£¹ï¼šæœƒåœ¨èƒŒæ™¯é¡¯ç¤ºæº«æš–çš„è‰²èª¿èˆ‡åœ–ç‰‡ -->
    <div class="autumn-section rounded-4 p-4 mb-4">
    <!-- Step 1: åŸºæœ¬è³‡è¨Š -->
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="mb-3">Step 1ï½œè¡Œç¨‹åŸºæœ¬è³‡è¨Š</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">è¡Œç¨‹åç¨±</label>
            <input id="tripName" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ 5 æ—¥è¼•æ—…è¡Œ">
          </div>
          <div class="col-md-6">
            <label class="form-label">åœ°å€ / åŸå¸‚</label>
            <input id="region" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ã€é—œè¥¿ã€æ²–ç¹©ã€é¦–çˆ¾ã€å°åŒ—">
          </div>
          <div class="col-md-3">
            <label class="form-label">é ç®—ï¼ˆTWDï¼‰</label>
            <div class="input-group">
              <input id="budget" type="number" min="0" step="1000" class="form-control" placeholder="ä¾‹å¦‚ï¼š30000">
            </div>
            <div class="form-text text-muted">ä»¥åƒå…ƒç‚ºå–®ä½èª¿æ•´ã€‚</div>
          </div>
          <div class="col-md-3">
            <label class="form-label">äººæ•¸</label>
            <input id="people" type="number" min="1" class="form-control" value="1">
          </div>
          <div class="col-md-3">
            <label class="form-label">å–®æ—¥éŠç©æ™‚é•·ï¼ˆå°æ™‚ï¼‰</label>
            <input id="dailyHours" type="number" min="1" max="24" class="form-control" value="8">
          </div>
          
        </div>
      </div>
    </div>

    <!-- Step 2: æœˆæ›†é¸æ—¥ -->
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="mb-3">Step 2ï½œé¸æ“‡æ—¥æœŸå€é–“</h5>
        <div class="row g-3">
          <div class="col-12">
            <div class="calendar-wrap">
              <div class="row g-3 align-items-start">
                <div class="col-md-4">
                  <div class="mb-2">
                    <label class="form-label mb-0">åŸºæº–æœˆä»½ï¼š</label>
                    <div class="d-flex gap-2 mt-1">
                      <select id="yearSel" class="form-select w-auto"></select>
                      <select id="monthSel" class="form-select w-auto"></select>
                    </div>
                  </div>
                  <div class="mb-3"><small class="text-muted">ç”¨ä¸‹æ–¹æœˆæ›†é¸æ“‡å‡ºç™¼èˆ‡çµæŸæ—¥æœŸ</small></div>
                  <div class="d-flex flex-column gap-2">
                    <div><span class="badge badge-soft">å‡ºç™¼ï¼š<span id="startText">â€”</span></span></div>
                    <div><span class="badge badge-soft">çµæŸï¼š<span id="endText">â€”</span></span></div>
                    <div><span class="badge badge-soft">å¤©æ•¸ï¼š<span id="daysText">0</span></span></div>
                  </div>
                </div>
                <div class="col-md-8">
                  <div class="d-grid" style="grid-template-columns:repeat(7,1fr);gap:.3rem">
                    <div class="weekday">æ—¥</div>
                    <div class="weekday">ä¸€</div>
                    <div class="weekday">äºŒ</div>
                    <div class="weekday">ä¸‰</div>
                    <div class="weekday">å››</div>
                    <div class="weekday">äº”</div>
                    <div class="weekday">å…­</div>
                  </div>
                  <div id="calendar" class="calendar mt-2"></div>
                  <div class="mt-2"><button id="btnResetDates" class="btn btn-sm btn-outline-secondary">Reset</button></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: æ—…éŠç¿’æ…£åå¥½ -->
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="mb-3">Step 3ï½œæœ‰åå¥½çš„æ—…éŠç¿’æ…£å—ï¼Ÿ</h5>
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">è¡Œç¨‹ç¯€å¥</label>
            <div id="pace" class="d-flex flex-wrap gap-2"></div>
          </div>
          <div class="col-12">
            <label class="form-label">åå¥½é¡å‹</label>
            <div id="types" class="d-flex flex-wrap gap-2"></div>
          </div>
          <div class="col-12">
            <label class="form-label">äº¤é€šåå¥½</label>
            <div id="transport" class="d-flex flex-wrap gap-2"></div>
          </div>
          <div class="col-12">
            <label class="form-label">ç”¨é¤å–å‘</label>
            <div id="dining" class="d-flex flex-wrap gap-2"></div>
          </div>
          <div class="card-body d-flex justify-content-center gap-2 align-items-center">
            <button id="btnSubmit" class="btn btn-primary">å»ºç«‹è¡Œç¨‹</button>
            <button id="btnDelete" class="btn btn-outline-danger">åˆªé™¤è¡Œç¨‹</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Debug é è¦½å€ï¼ˆå¯æ”¶åˆï¼‰ -->
    <div class="card mt-3">
      <div class="card-body">
        <details>
          <summary class="pointer">JSON é è¦½</summary>
          <pre id="jsonPreview" class="mt-3" style="white-space:pre-wrap"></pre>
        </details>
      </div>
    </div>

    </div> <!-- /.autumn-section -->
  </main>

  <script>
    // ====== 0. Hero å€å¡Šé‚è¼¯ ======
    document.addEventListener('DOMContentLoaded', function(){
      const btn = document.getElementById('heroBtn');
      if(btn){
        btn.addEventListener('click', function(){
          const main = document.querySelector('main.container');
          if(main) main.scrollIntoView({behavior:'smooth'});
        });
      }
      
      // Hero åœ–ç‰‡è¼ªæ’­
      (function heroSlideshow(){
        const images = [
          'Source_img/image1.jpg',
          'Source_img/image2.jpg'
        ];
        const intervalMs = 10000;
        const container = document.querySelector('.hero-slides');
        if(!container || !images || images.length===0) return;

        const slides = images.map((src,i)=>{
          const d = document.createElement('div');
          d.className = 'hero-slide'+(i===0? ' active':'');
          d.style.backgroundImage = `url(${src})`;
          container.appendChild(d);
          return d;
        });

        let idx = 0;
        setInterval(()=>{
          const next = (idx+1) % slides.length;
          slides[idx].classList.remove('active');
          slides[next].classList.add('active');
          idx = next;
        }, intervalMs);
      })();
    });
    // ====== 1. è¨­å®š ======
    const storeKey = 'travel_assistant_trip_setup_v1';
    const API = "/api";
    
    // ç‹€æ…‹åˆå§‹åŒ–
    let state = tryLoadState() || {
      name: '', region: '', budget: 0, people: 1, dailyHours: 8,
      year: new Date().getFullYear(), month: new Date().getMonth()+1,
      startDay: null, endDay: null,
      prefs: { pace: 'é©ä¸­', types: [], transport: [], dining: [] }
    };

    function tryLoadState(){ try{ return JSON.parse(localStorage.getItem(storeKey)||''); }catch{ return null; } }
    function saveState(){ localStorage.setItem(storeKey, JSON.stringify(state)); renderPreview(); }

    // ====== 2. DOM å…ƒç´  ======
    const els = {
      tripName: document.getElementById('tripName'), region: document.getElementById('region'),
      budget: document.getElementById('budget'), people: document.getElementById('people'), dailyHours: document.getElementById('dailyHours'),
      yearSel: document.getElementById('yearSel'), monthSel: document.getElementById('monthSel'), calendar: document.getElementById('calendar'),
      startText: document.getElementById('startText'), endText: document.getElementById('endText'), daysText: document.getElementById('daysText'),
      btnSubmit: document.getElementById('btnSubmit'), btnDelete: document.getElementById('btnDelete'),
      jsonPreview: document.getElementById('jsonPreview'),
      pace: document.getElementById('pace'), types: document.getElementById('types'), transport: document.getElementById('transport'), dining: document.getElementById('dining'),
      resetDates: document.getElementById('btnResetDates'), tripSel: document.getElementById('tripSel'),
      pName: document.getElementById('pName'), pRegion: document.getElementById('pRegion'), pDate: document.getElementById('pDate'),
      pDays: document.getElementById('pDays'), pPeople: document.getElementById('pPeople'), pHours: document.getElementById('pHours')
    };

    // ====== 3. è¼”åŠ©å‡½å¼ ======
    
    // ğŸŸ¢ [é—œéµä¿®æ”¹] å¼·åˆ¶æ›´æ–°æŒ‰éˆ•ç‹€æ…‹çš„å‡½å¼
    function updateButtonUI() {
        const isNew = (!els.tripSel.value || els.tripSel.value === 'new');
        if (isNew) {
            els.btnSubmit.textContent = 'å»ºç«‹è¡Œç¨‹';
            els.btnSubmit.className = 'btn btn-primary'; // è—è‰²
            if(els.btnDelete) els.btnDelete.disabled = true;
        } else {
            els.btnSubmit.textContent = 'æ›´æ–°è¡Œç¨‹';
            els.btnSubmit.className = 'btn btn-success'; // ç¶ è‰²
            if(els.btnDelete) els.btnDelete.disabled = false;
        }
    }

    function initYearMonth(){
      const y = state.year; const m = state.month; const nowY = new Date().getFullYear();
      els.yearSel.innerHTML = [-1,0,1,2,3].map(i=>`<option ${nowY+i===y?'selected':''}>${nowY+i}</option>`).join('');
      els.monthSel.innerHTML = Array.from({length:12},(_,i)=>i+1).map(v=>`<option ${v===m?'selected':''}>${v}</option>`).join('');
    }

    function renderChips(container, options, single=false, key){
      container.innerHTML='';
      options.forEach(opt=>{
        const active = single ? (state.prefs[key]===opt) : (state.prefs[key]?.includes(opt));
        const btn = document.createElement('button');
        btn.type='button'; btn.className='pref-chip'+(active?' active':''); btn.textContent=opt;
        btn.addEventListener('click', ()=>{
          if(single){ state.prefs[key] = opt; }
          else{ const arr = new Set(state.prefs[key]||[]); if(arr.has(opt)) arr.delete(opt); else arr.add(opt); state.prefs[key] = Array.from(arr); }
          saveState(); renderChips(container, options, single, key);
        });
        container.appendChild(btn);
      });
    }

    function buildCalendar(){
      const y=parseInt(els.yearSel.value), m=parseInt(els.monthSel.value);
      state.year=y; state.month=m; saveState();
      const dim=new Date(y,m,0).getDate(), off=new Date(y,m-1,1).getDay();
      let html=''; for(let i=0;i<off;i++) html+=`<div></div>`;
      for(let d=1;d<=dim;d++){
        const sel=(state.startDay&&state.endDay&&d>=state.startDay&&d<=state.endDay);
        html+=`<div class="day ${sel?'selected':''}" data-day="${d}">${d}</div>`;
      }
      els.calendar.innerHTML=html; updateRangeText();
      els.calendar.querySelectorAll('.day').forEach(el=>el.addEventListener('click',()=>selectDay(parseInt(el.dataset.day))));
    }

    function selectDay(d){
      if(!state.startDay||(state.startDay&&state.endDay)){ state.startDay=d; state.endDay=null; }
      else{ if(d<state.startDay){state.endDay=state.startDay;state.startDay=d;}else{state.endDay=d;} }
      saveState(); buildCalendar();
    }

    function updateRangeText(){
      const y=state.year,m=state.month,s=state.startDay,e=state.endDay; const pad=n=>String(n).padStart(2,'0');
      els.startText.textContent=s?`${y}-${pad(m)}-${pad(s)}`:'â€”'; els.endText.textContent=e?`${y}-${pad(m)}-${pad(e)}`:'â€”'; els.daysText.textContent=(s&&e)?(e-s+1):0;
    }

    function currentPayload(){
      const s=state.startDay, e=state.endDay, pad=n=>String(n).padStart(2,'0');
      return {
        name: state.name?.trim()||'', region: state.region?.trim()||'',
        budget_twd: Number(state.budget)||0, people: Number(state.people)||1, daily_hours: Number(state.dailyHours)||8,
        start_date: s?`${state.year}-${pad(state.month)}-${pad(s)}`:'', days: (s&&e)?(e-s+1):0,
        preferences: state.prefs
      };
    }

    function syncInputs(){
      els.tripName.value=state.name; els.region.value=state.region; els.budget.value=state.budget;
      els.people.value=state.people; els.dailyHours.value=state.dailyHours; els.yearSel.value=state.year; els.monthSel.value=state.month;
      renderPreview();
    }

    function renderPreview(){
      if(els.jsonPreview) els.jsonPreview.textContent = JSON.stringify(currentPayload(), null, 2);
      const p = currentPayload();
      if(els.pName) els.pName.textContent = p.name || 'â€”';
      if(els.pRegion) els.pRegion.textContent = p.region || 'â€”';
      if(els.pDate) els.pDate.textContent = p.start_date || 'â€”';
      if(els.pDays) els.pDays.textContent = p.days;
      if(els.pPeople) els.pPeople.textContent = p.people;
      if(els.pHours) els.pHours.textContent = p.daily_hours;
    }

    // ====== 4. äº‹ä»¶ç¶å®š ======
    const paceOpts=['æ‚ é–’','é©ä¸­','ç·Šæ¹Š'], typeOpts=['æ™¯é»','ç¾é£Ÿ','è³¼ç‰©','è‡ªç„¶','åšç‰©é¤¨','å¤œç”Ÿæ´»','è¦ªå­','å±•æ¼”'];
    const transportOpts=['æ­¥è¡Œ','å¤§çœ¾é‹è¼¸','è¨ˆç¨‹è»Š','è‡ªé§•'], diningOpts=['åœ¨åœ°å°åƒ','ç±³å…¶æ—/è©•é‘‘','å¹³åƒ¹å„ªå…ˆ','ç´ é£Ÿå‹å–„'];

    initYearMonth();
    renderChips(els.pace,paceOpts,true,'pace'); renderChips(els.types,typeOpts,false,'types');
    renderChips(els.transport,transportOpts,false,'transport'); renderChips(els.dining,diningOpts,false,'dining');

    els.budget.addEventListener('input',()=>{state.budget=els.budget.value;saveState();});
    els.tripName.addEventListener('input',()=>{state.name=els.tripName.value;saveState();});
    els.region.addEventListener('input',()=>{state.region=els.region.value;saveState();});
    els.people.addEventListener('input',()=>{state.people=els.people.value;saveState();});
    els.dailyHours.addEventListener('input',()=>{state.dailyHours=els.dailyHours.value;saveState();});
    els.yearSel.addEventListener('change',buildCalendar); els.monthSel.addEventListener('change',buildCalendar);
    if(els.resetDates) els.resetDates.addEventListener('click', ()=>{state.startDay=null;state.endDay=null;saveState();buildCalendar();});

    // ====== 5. API è¼‰å…¥ ======
    async function fetchJSON(url){const r=await fetch(url);if(!r.ok)throw new Error(r.status);return r.json();}
    
    async function loadTripList(){
      try{
        const list=await fetchJSON(`${API}/trips`);
        const cur=els.tripSel.value;
        els.tripSel.innerHTML=`<option value="new">ï¼ˆæ–°å»ºï¼‰</option>`+list.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
        
        // ä¿æŒé¸æ“‡
        if(cur!=='new' && list.some(t=>String(t.id)===cur)) els.tripSel.value = cur;
        else els.tripSel.value = 'new';
        
        // è¼‰å…¥å®Œæ¸…å–®å¾Œï¼Œç¢ºèªä¸€æ¬¡æŒ‰éˆ•ç‹€æ…‹
        updateButtonUI();
      }catch(e){}
    }

    async function loadTripById(id){
      try{
        const t=await fetchJSON(`${API}/trips/${id}`);
        state.name=t.name; state.region=t.region; state.budget=t.budget_twd; state.people=t.people; state.dailyHours=t.daily_hours;
        if(t.start_date){const [y,m,d]=t.start_date.split('-').map(Number); state.year=y; state.month=m; state.startDay=d; state.endDay=d+(t.days)-1;}
        state.prefs = t.preferences || { pace: 'é©ä¸­', types: [], transport: [], dining: [] };
        
        // æ›´æ–° UI
        renderChips(els.pace,paceOpts,true,'pace'); renderChips(els.types,typeOpts,false,'types');
        renderChips(els.transport,transportOpts,false,'transport'); renderChips(els.dining,diningOpts,false,'dining');
        saveState(); syncInputs(); buildCalendar();
        
        // ğŸŸ¢ [é—œéµ] åªè¦è®€å–æˆåŠŸï¼Œå°±å¼·åˆ¶æ›´æ–°æŒ‰éˆ•
        updateButtonUI(); 

      }catch(e){
        alert('è®€å–å¤±æ•—');
        els.tripSel.value = 'new';
        updateButtonUI();
      } 
    }

    els.tripSel.addEventListener('change',()=>{
        if(els.tripSel.value==='new'){
            // é‡ç½®
            localStorage.removeItem(storeKey); 
            state = { name: '', region: '', budget: 0, people: 1, dailyHours: 8, year: new Date().getFullYear(), month: new Date().getMonth()+1, startDay: null, endDay: null, prefs: { pace: 'é©ä¸­', types: [], transport: [], dining: [] } };
            saveState(); syncInputs(); buildCalendar();
            renderChips(els.pace,paceOpts,true,'pace'); renderChips(els.types,typeOpts,false,'types');
            renderChips(els.transport,transportOpts,false,'transport'); renderChips(els.dining,diningOpts,false,'dining');
            updateButtonUI();
        }else{
            loadTripById(els.tripSel.value);
        }
    });

    // ====== 6. ğŸš€ [æŒ‰éˆ•é‚è¼¯] ======
    els.btnSubmit.addEventListener('click', async ()=>{
      const p = currentPayload();
      if(!p.name || !p.region || !p.start_date || p.days<=0){ alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Šèˆ‡æ—¥æœŸ'); return; }

      // ä¾æ“šä¸‹æ‹‰é¸å–®çš„å€¼ä¾†æ±ºå®šæ˜¯ New é‚„æ˜¯ Update
      const isUpdate = (els.tripSel.value !== 'new');
      
      els.btnSubmit.disabled = true;
      els.btnSubmit.textContent = isUpdate ? 'æ›´æ–°ä¸­â€¦' : 'å»ºç«‹ä¸­â€¦';

      try {
        let finalId = null; 

        if(isUpdate){
          // === æ›´æ–°æ¨¡å¼ ===
          // ç›´æ¥ä½¿ç”¨é¸å–®ä¸Šçš„ IDï¼Œä¸ä¾è³´å¾Œç«¯å›å‚³
          finalId = els.tripSel.value;
          
          const resp = await fetch(`${API}/trips/${finalId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                id: Number(finalId), // å¿…å‚³
                name: p.name, region: p.region, start_date: p.start_date, days: p.days,
                budget_twd: p.budget_twd, people: p.people, daily_hours: p.daily_hours,
                preferences: p.preferences,
                plan: [] // æ¸…ç©º Plan è®“ Chat é‡æ–°è¦åŠƒ
            })
          });
          if(!resp.ok) throw new Error(await resp.text());

        } else {
          // === æ–°å»ºæ¨¡å¼ ===
          const resp = await fetch(`${API}/trips`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: p.name, region: p.region, start_date: p.start_date, days: p.days,
                budget_twd: p.budget_twd, people: p.people, daily_hours: p.daily_hours,
                preferences: p.preferences
            })
          });
          if(!resp.ok) throw new Error(await resp.text());
          const newTrip = await resp.json();
          finalId = newTrip.id; // æ–°å»ºçš„å¿…é ˆæ‹¿å¾Œç«¯ ID
        }

        // æ¸…é™¤è©² ID çš„èˆŠå°è©± (å¼·è¿« Chat é é¢é‡ä¾†)
        localStorage.removeItem(`chat_history_${finalId}`);

        // è·³è½‰
        console.log("è·³è½‰ ID:", finalId);
        window.location.href = `/web/chat.html?trip=${finalId}`;

      } catch(err) {
        console.error(err);
        alert('æ“ä½œå¤±æ•—ï¼š' + err.message);
        els.btnSubmit.disabled=false; 
        updateButtonUI(); // å›å¾©æŒ‰éˆ•ç‹€æ…‹
      }
    });

    if(els.btnDelete) els.btnDelete.addEventListener('click', async()=>{
      if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))return;
      await fetch(`${API}/trips/${els.tripSel.value}`,{method:'DELETE'});
      loadTripList();
      els.tripSel.value = 'new';
      updateButtonUI();
    });

    // 1. åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
    initYearMonth(); 
    
    // 2. æ¸²æŸ“ UI å…ƒä»¶
    renderChips(els.pace,paceOpts,true,'pace'); 
    renderChips(els.types,typeOpts,false,'types');
    renderChips(els.transport,transportOpts,false,'transport'); 
    renderChips(els.dining,diningOpts,false,'dining');

    // 3. å»ºç«‹æ—¥æ›† (é€™è¡Œæœ€é‡è¦ï¼Œæ²’è·‘é€™è¡Œæ—¥æ›†å°±æ˜¯ç©ºçš„)
    buildCalendar(); 

    // 4. è¼‰å…¥åˆ—è¡¨èˆ‡ç‹€æ…‹
    loadTripList();
    updateButtonUI();
  </script>
</body>
</html>
