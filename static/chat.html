<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—…éŠåŠ©æ‰‹ â€” äº’å‹•è¦åŠƒ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Chat bubble improvements: preserve newlines and wrap long lines */
    .chat-container{ max-width:1100px; margin:1.5rem auto; }
    .llm-pane, .user-pane{ overflow:auto; max-height:60vh; }
    .msg{ margin-bottom: .75rem; }
    .bubble{ background:#ffffff; border-radius:12px; padding:.75rem 1rem; box-shadow:0 6px 18px rgba(2,6,23,.06); max-width:78%; white-space:pre-wrap; word-break:break-word; line-height:1.6; }
    .msg.llm .bubble{ background: linear-gradient(180deg,#fff,#fbfbff); color:#0f172a; }
    .msg.user{ text-align:right; }
    .msg.user .bubble{ background: linear-gradient(90deg,#dcfce7,#bbf7d0); display:inline-block; }
    /* make bubbles readable on small screens */
    @media (max-width:768px){ .bubble{ max-width:92%; } }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg mb-3" style="background:linear-gradient(90deg,#ffffff,#fdebd0);">
    <div class="container">
      <a class="navbar-brand" href="/web/">æ—…éŠåŠ©æ‰‹</a>
      <div class="ms-auto">
        <button id="backBtn" class="btn btn-outline-secondary btn-sm">å›åˆ—è¡¨</button>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="chat-container shadow-sm rounded-3 p-3">
      <div class="row g-0">
        <div class="col-md-8 chat-area">
          <div id="llmPane" class="llm-pane p-3">
            <!-- LLM messages (left) -->
          </div>
        </div>
        <div class="col-md-4 chat-area bg-light border-start">
          <div id="userPane" class="user-pane p-3">
            <!-- User messages (right) -->
          </div>
        </div>
      </div>

      <div class="chat-input-bar mt-3 d-flex gap-2">
        <input id="chatInput" class="form-control" placeholder="è¼¸å…¥ä½ çš„å•é¡Œæˆ–æŒ‡ç¤ºï¼ˆä¾‹å¦‚ï¼šå¹«æˆ‘èª¿æ•´è¡Œç¨‹ï¼‰" />
        <button id="sendBtn" class="btn btn-primary">ğŸ’¬</button>
      </div>
      <!-- Instant display: messages revealed immediately (no typing) -->
    </div>
  </main>

  <script>
    // Chat UI with typewriter effect for saved responses
    const params = new URLSearchParams(location.search);
    const tripId = params.get('trip') || params.get('tripId') || null;
    const API = '/api';

    document.getElementById('backBtn').addEventListener('click', ()=>{ location.href = '/web/'; });

    const llmPane = document.getElementById('llmPane');
    const userPane = document.getElementById('userPane');
    const input = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');

    function appendUser(text){
      const el = document.createElement('div');
      el.className = 'msg user mb-3 text-end';
      el.innerHTML = `<div class="bubble user-bubble d-inline-block">${text}</div>`;
      userPane.appendChild(el);
      userPane.scrollTop = userPane.scrollHeight;
    }

    function appendLLMBubble(){
      const el = document.createElement('div');
      el.className = 'msg llm mb-3';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      el.appendChild(bubble);
      llmPane.appendChild(el);
      llmPane.scrollTop = llmPane.scrollHeight;
      return bubble;
    }

    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    // Format message: escape HTML and preserve newlines as <br> (no bolding)
    function escapeHtml(str){
      return String(str).replace(/[&<>\"]/g, function(s){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]);
      });
    }

    function formatMessageToHtml(text){
      if(text == null) return '';
      const normalized = String(text).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
      // escape HTML first
      let escaped = escapeHtml(normalized);
      // convert Markdown bold **text** into <strong>text</strong>
      // This removes the literal ** markers and renders bold safely.
      escaped = escaped.replace(/\*\*(.+?)\*\*/g, function(_, p1){ return '<strong>' + p1 + '</strong>'; });
      // convert lines that start with '* ' into a small bullet 'â€¢ '
      const lines = escaped.split('\n').map(line => {
        const m = line.match(/^\s*\*\s+(.*)$/);
        if(m){
          return 'â€¢ ' + m[1];
        }
        return line;
      });
      return lines.join('<br>');
    }

    // Instant display helper (renders safe HTML with line breaks)
    function displayText(bubbleEl, text){
      bubbleEl.innerHTML = formatMessageToHtml(text);
      llmPane.scrollTop = llmPane.scrollHeight;
    }

    // Fetch saved response.json and play responses sequentially with typing effect
    async function playSavedResponses(){
      try{
        const res = await fetch(`${API}/gemini/response`);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        const arr = data && data.response ? data.response : [];
        if(!Array.isArray(arr) || arr.length===0) {
          // show welcome message
          const b = appendLLMBubble();
          await typeText(b, `æ­¡è¿ï¼${tripId ? 'æ­£åœ¨ç·¨è¼¯è¡Œç¨‹ ID: ' + tripId : 'å°šæœªæŒ‡å®šè¡Œç¨‹' }ï¼Œè«‹è¼¸å…¥ä½ çš„éœ€æ±‚æˆ–å•é¡Œã€‚`, 20);
          return;
        }

        // play each response with pause between
        for(const txt of arr){
          const bubble = appendLLMBubble();
          displayText(bubble, txt);
        }
      }catch(err){
        console.warn('load responses failed', err);
        const b = appendLLMBubble();
        await typeText(b, `æ­¡è¿ï¼${tripId ? 'æ­£åœ¨ç·¨è¼¯è¡Œç¨‹ ID: ' + tripId : 'å°šæœªæŒ‡å®šè¡Œç¨‹' }ï¼Œè«‹è¼¸å…¥ä½ çš„éœ€æ±‚æˆ–å•é¡Œã€‚`, 20);
      }
    }

    // send button behaviour (user can send messages)
    sendBtn.addEventListener('click', async ()=>{
      const txt = input.value.trim(); if(!txt) return; input.value = '';
      appendUser(txt);
      const b = appendLLMBubble();
      displayText(b, 'ï¼ˆæ­£åœ¨å°‡æ‚¨çš„å•é¡Œé€å‡ºâ€¦ï¼‰');
    });
    // No speed controls: messages show instantly

    // Start
    document.addEventListener('DOMContentLoaded', ()=>{ playSavedResponses(); });
  </script>
</body>
</html>
