  <!doctype html>
  <html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ—…éŠåŠ©æ‰‹ â€” äº’å‹•è¦åŠƒ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
      :root{
        --bg-1: #fff6f3; /* soft cream */
        --card-bg: #ffffff;
        --accent: #2463ff; /* blue accent */
        --muted: #f3ece8;
        --llm-text: #0f172a;
        --user-text: #003826;
      }

      html, body { height:100%; }
      body{ background: linear-gradient(180deg,var(--bg-1),#fffaf8); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; overflow:hidden; }

      /* Full-bleed chat card: remove side margins so the card stretches to viewport edges */
      .chat-container{ width:100%; max-width:none; margin:0; padding:0; border-radius:0; }
      .chat-area{ min-height:68vh; }

      /* Main chat pane (single column) â€” larger and centered left-to-right with roomy right side */
      /* full-bleed pane: let the pane span full width, keep inner padding as gutters */
      .llm-pane{ background: var(--card-bg); border-radius:0; padding:2rem 1.25rem 2rem 2rem; box-shadow:none; overflow:auto; max-height: calc(100vh - 180px); box-sizing:border-box; width:100%; }

      /* Message bubbles */
      .msg{ margin-bottom:1.25rem; display:flex; }
      .bubble{ background:transparent; border-radius:14px; padding:0.9rem 1.05rem; max-width:78%; white-space:pre-wrap; word-break:break-word; line-height:1.7; font-size:1.03rem; }
      .msg.llm{ justify-content:flex-start; }
      .msg.llm .bubble{ background: linear-gradient(180deg,var(--card-bg),#fbfdff); color:var(--llm-text); box-shadow:0 6px 18px rgba(2,6,23,.04); }
      .msg.user{ justify-content:flex-end; }
      .msg.user .bubble{ background: linear-gradient(90deg,#e6fff2,#c8f2d9); color:var(--user-text); box-shadow:0 6px 18px rgba(2,6,23,.04); }
      .msg.user .bubble{ display:inline-block; margin-left:12px; }

      /* remove extra side gutters for full-bleed; keep small padding on very wide screens if desired */
      @media (min-width:1400px){ .llm-pane{ padding-left:4rem; padding-right:2.5rem; } }

      /* Input area styling and accent button */
      .chat-input-bar{ margin-top:1.25rem; display:flex; gap:0.75rem; align-items:center; }
      .chat-input-bar .form-control{ border-radius:14px; padding:1rem 1rem; box-shadow:0 6px 18px rgba(2,6,23,.03) inset; }
      .chat-input-bar .btn{ background:var(--accent); border:none; color:#fff; padding:0.7rem 0.9rem; border-radius:12px; box-shadow:0 8px 20px rgba(36,99,255,0.18); }

      /* small screens behavior */
      @media (max-width:992px){ .chat-container{ max-width:95%; padding-left:16px; padding-right:16px; } .bubble{ max-width:92%; } }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg mb-3" style="background:linear-gradient(90deg,#ffffff,#fdebd0);">
      <div class="container">
        <a class="navbar-brand" href="/web/">æ—…éŠåŠ©æ‰‹</a>
        <div class="ms-auto">
          <button id="backBtn" class="btn btn-outline-secondary btn-sm">å›åˆ—è¡¨</button>
        </div>
      </div>
    </nav>

    <main class="container-fluid">
      <div class="chat-container shadow-sm rounded-3 p-3">
        <div class="row g-0">
          <div class="col-md-9 chat-area">
            <div id="llmPane" class="llm-pane p-3">
              <!-- LLM messages (left) -->
            </div>
          </div>
          <!-- right column removed: user messages will appear inside the main llmPane as right-aligned bubbles -->
        </div>

        <div class="chat-input-bar mt-3 d-flex gap-2">
          <input id="chatInput" class="form-control" placeholder="è¼¸å…¥ä½ çš„å•é¡Œæˆ–æŒ‡ç¤ºï¼ˆä¾‹å¦‚ï¼šå¹«æˆ‘èª¿æ•´è¡Œç¨‹ï¼‰" />
          <button id="sendBtn" class="btn btn-primary">ğŸ’¬</button>
        </div>
        <!-- Instant display: messages revealed immediately (no typing) -->
      </div>
    </main>

    <script>
      // ====== 1. åŸºç¤è¨­å®š ======
      const API = '/api';
      const params = new URLSearchParams(location.search);
      const rawId = params.get('trip') || params.get('tripId');
      // å¦‚æœæ²’æœ‰ IDï¼Œå°±è¨­ç‚º null
      const tripId = (rawId && rawId !== 'undefined' && rawId !== 'null') ? rawId : null;
      const STORAGE_KEY = `chat_history_${tripId}`;
      let chatHistory = []; 

      document.getElementById('backBtn').addEventListener('click', () => {
        if (tripId) {
          // from=chat åªæ˜¯æ¨™è¨˜ä¸€ä¸‹æ˜¯å¾èŠå¤©é å›ä¾†
          location.href = `/web/?trip=${encodeURIComponent(tripId)}&from=chat`;
        } else {
          location.href = '/web/';
        }
      });

      const llmPane = document.getElementById('llmPane');
      const input = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');

      // ====== 2. UI æ¸²æŸ“å·¥å…· ======
      function formatMessageToHtml(text){
        if(!text) return '';
        let escaped = String(text).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        escaped = escaped.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        escaped = escaped.replace(/### (.*)/g, '<h4>$1</h4>'); // æ¨™é¡Œ
        return escaped.split('\n').map(line => line.match(/^\s*\*\s+(.*)$/) ? 'â€¢ ' + RegExp.$1 : line).join('<br>');
      }
      
      function createBubble(role, text) {
          const el = document.createElement('div'); 
          el.className = `msg ${role} mb-3`;
          const bubble = document.createElement('div'); 
          bubble.className = `bubble ${role==='user'?'user-bubble d-inline-block':''}`;
          bubble.innerHTML = formatMessageToHtml(text);
          el.appendChild(bubble);
          llmPane.appendChild(el);
          llmPane.scrollTop = llmPane.scrollHeight;
          return bubble;
      }
      
      // ç”¨ä¾†æ›´æ–°æ³¡æ³¡å…§å®¹ (ä¾‹å¦‚å¾ "æ€è€ƒä¸­" è®Šæˆ "çµæœ")
      function displayText(bubble, text) { 
          bubble.innerHTML = formatMessageToHtml(text); 
          llmPane.scrollTop = llmPane.scrollHeight; 
      }
      
      function saveHistory() { 
          if(tripId) localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory)); 
      }

      // ========== ä¿®æ­£å¾Œçš„ sendMessage ==========
      async function sendMessage(text, isAutoTrigger = false) {
        if (!text) return;

        if (!isAutoTrigger) {
          createBubble('user', text);
        }

        chatHistory.push({ role: 'user', text });
        saveHistory();

        const loadingBubble = createBubble('llm', 'ï¼ˆæ­£åœ¨æ€è€ƒèˆ‡è¦åŠƒ...ï¼‰');

        try {
          const res = await fetch(`${API}/gemini/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, history: chatHistory })
          });

          if (!res.ok) {
            let errorMsg = 'API Error ' + res.status;
            try {
              const errData = await res.json();
              if (errData && errData.error) {
                errorMsg = errData.error;
              }
            } catch (_ignore) {
              // å¾Œç«¯ä¸æ˜¯ JSONï¼Œå°±ç¶­æŒåŸæœ¬çš„ errorMsg
            }
            throw new Error(errorMsg);
          }

          const data = await res.json();
          const reply = (data && data.reply) ? data.reply : '(ç„¡å›æ‡‰)';

          displayText(loadingBubble, reply);
          chatHistory.push({ role: 'model', text: reply });
          saveHistory();

        } catch (e) {
          console.error(e);
          const msg = e && e.message ? e.message : String(e);
          displayText(loadingBubble, 'ç™¼ç”ŸéŒ¯èª¤ï¼š' + msg);
        }
      }


      // ====== 4. åˆå§‹åŒ– (é€²ä¾†é é¢æ™‚åŸ·è¡Œ) ======
      async function initChat() {
          if (!tripId) {
              createBubble('llm', "ğŸ‘‹ ä½ å¥½ï¼ç¶²å€ä¼¼ä¹ç¼ºå°‘è¡Œç¨‹ IDã€‚<br>è«‹å›åˆ°ä¸Šä¸€é é‡æ–°å»ºç«‹è¡Œç¨‹ã€‚");
              return;
          }

          const saved = localStorage.getItem(STORAGE_KEY);

          if (saved) {
              // A. æœ‰èˆŠç´€éŒ„ï¼šè¼‰å…¥ä¸¦é¡¯ç¤º
              try {
                  chatHistory = JSON.parse(saved);
                  if(chatHistory.length > 0) {
                      chatHistory.forEach(msg => {
                          // éæ¿¾æ‰ç³»çµ±æŒ‡ä»¤ï¼Œåªé¡¯ç¤ºæ­£å¸¸çš„å°è©±
                          if (!msg.text.startsWith('SYSTEM_prompt:')) {
                              createBubble(msg.role, msg.text);
                          }
                      });
                      // å¦‚æœè¼‰å…¥å®Œæ²’æ±è¥¿ (ä¾‹å¦‚åªæœ‰éš±è—æŒ‡ä»¤)ï¼Œè£œå€‹æ­¡è¿è©
                      // if(llmPane.children.length === 0) createBubble('llm', "æ­¡è¿å›ä¾†ï¼");
                  } else {
                      // æœ‰ key ä½†å…§å®¹æ˜¯ç©ºé™£åˆ—
                      startNewPlanning();
                  }
              } catch(e) {
                  console.error("History parse error", e);
                  startNewPlanning();
              }
          } else {
              // B. ç„¡ç´€éŒ„ï¼šé–‹å§‹æ–°è¦åŠƒ
              startNewPlanning();
          }
      }

      // é–‹å§‹å…¨æ–°çš„è¦åŠƒæµç¨‹
      async function startNewPlanning() {
          const bubble = createBubble('llm', "æ­£åœ¨è®€å–æ‚¨çš„è¡Œç¨‹è¨­å®š...");
          
          try {
              // 1. å»è³‡æ–™åº«æŠ“ä½¿ç”¨è€…çš„è¨­å®š (index.html å­˜çš„é‚£ä»½)
              const res = await fetch(`${API}/trips/${tripId}`);
              if (res.ok) {
                  const tripData = await res.json();
                  
                  // æ›´æ–°æ³¡æ³¡æ–‡å­—
                  displayText(bubble, `å—¨ï¼æˆ‘çœ‹åˆ°æ‚¨æƒ³å» **${tripData.region}** ç© ${tripData.days} å¤©ã€‚\næˆ‘æ­£åœ¨æ ¹æ“šæ‚¨çš„åå¥½ï¼ˆ${tripData.preferences?.pace || 'é©ä¸­'}ã€${tripData.preferences?.types?.join('/') || 'ç„¡'}ï¼‰ç‚ºæ‚¨è¦åŠƒ...`);
                  
                  // 2. çµ„è£æŒ‡ä»¤çµ¦ AI (é€™æ®µä½¿ç”¨è€…çœ‹ä¸åˆ°)
                  const prompt = `SYSTEM_prompt: è«‹æ‰®æ¼”å°ˆæ¥­å°éŠã€‚
  é€™æ˜¯ä½¿ç”¨è€…çš„è¡Œç¨‹éœ€æ±‚ JSONï¼š${JSON.stringify(tripData)}
  è«‹æ ¹æ“šæ­¤è³‡è¨Šï¼Œè¦åŠƒä¸€ä»½è©³ç´°çš„${tripData.days}å¤©è¡Œç¨‹ã€‚
  è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œæ¢åˆ—å¼å‘ˆç¾ï¼ŒåŒ…å«æ¯å¤©çš„æ™¯é»ã€é¤é£²å»ºè­°ã€‚
  è«‹ç›´æ¥é–‹å§‹è¦åŠƒï¼Œä¸ç”¨è§£é‡‹ã€‚`;
                  
                  // 3. è‡ªå‹•ç™¼é€
                  await sendMessage(prompt, true);
                  
              } else {
                  displayText(bubble, `æ‰¾ä¸åˆ°è¡Œç¨‹è³‡æ–™ (ID: ${tripId})ã€‚è«‹ç¢ºèªæ˜¯å¦å·²å»ºç«‹ã€‚`);
              }
          } catch (e) { 
              console.error(e);
              displayText(bubble, "é€£ç·šéŒ¯èª¤ï¼Œç„¡æ³•è®€å–è¡Œç¨‹ã€‚");
          }
      }

      sendBtn.addEventListener('click', () => { const t=input.value.trim(); input.value=''; sendMessage(t); });
      input.addEventListener('keypress', (e) => { if(e.key==='Enter'){ const t=input.value.trim(); input.value=''; sendMessage(t); } });

      // å•Ÿå‹•
      document.addEventListener('DOMContentLoaded', initChat);
    </script>
  </body>
  </html>
